#!/usr/bin/env ruby

require 'Ops'

def exit_failure( reason="", code=1 )
  puts reason; exit
end

def root_dir
  File.dirname( File.dirname( __FILE__ ) )
end unless defined? :root_dir

def pwd_dir
  Dir.pwd
end

root_tasks_dir = File.join( root_dir, "tasks", "**", "*" )
pwd_tasks_dir = File.join( pwd_dir, "tasks", "**", "*" )

bootstrap_tasks = [ 'ops.rb' ]

tasks = Dir.glob( root_tasks_dir ).reject do |r|
  bootstrap_tasks.include? File.basename(r)
end

Rake.application.init( File.basename( $0 ) )

begin
  bootstrap_tasks.each do | f |
    require File.join( root_dir, 'tasks', f )
  end

  tasks.each do | f |
    require f
  end
rescue => e
  puts e
end

Dir.glob( pwd_tasks_dir ).each do | f |
  require f
end if File.directory? pwd_tasks_dir

begin
  Rake.application.top_level
rescue => e
  puts "Failed to call task: #{ e.message }"
end

exit
